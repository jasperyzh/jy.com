---
/**
 * GiveHeart Component
 *
 * Purpose: Interactive heart button that saves clicks to Supabase PostgreSQL
 * Displays total heart count with animations and implements rate limiting
 *
 * Props:
 * - pageUrl?: string (optional) - Page URL to track hearts for (defaults to current page)
 *
 * Usage:
 * <GiveHeart />
 * <GiveHeart pageUrl="/blog/my-post" />
 */
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"div"> {
  pageUrl?: string;
}

const { pageUrl, ...rest } = Astro.props;
const currentPageUrl = pageUrl || Astro.url.pathname;
---

<div class="give-heart" data-page-url={currentPageUrl} {...rest}>
  <button class="give-heart-button" type="button" aria-label="Give a heart">
    <span class="heart-icon" aria-hidden="true">ðŸ’–</span>
    <span class="give-heart-text">Give a heart</span>
  </button>
  <span class="heart-count" aria-live="polite">â€”</span>
</div>

<script>
  // Initialize heart component
  document.addEventListener("DOMContentLoaded", async () => {
    const heartComponents = document.querySelectorAll(".give-heart");

    heartComponents.forEach((component) => {
      const button = component.querySelector(
        ".give-heart-button"
      ) as HTMLButtonElement | null;
      const heartIcon = component.querySelector(".heart-icon");
      const countElement = component.querySelector(".heart-count");
      const pageUrlAttr = component.getAttribute("data-page-url");

      if (!button || !countElement || !pageUrlAttr) return;

      const pageUrl = pageUrlAttr;
      let isSubmitting = false;
      let currentCount = 0;

      // Fetch initial count
      async function fetchCount() {
        try {
          console.log("Fetching count for pageUrl:", pageUrl); // Add this
          const response = await fetch(
            `/api/hearts?pageUrl=${encodeURIComponent(pageUrl)}`
          );
          if (response.ok) {
            const data = await response.json();
            console.log("Received count:", data.count); // Add this
            currentCount = data.count || 0;
            updateCountDisplay();
          }
        } catch (error) {
          console.error("Failed to fetch heart count:", error);
        }
      }

      // Update count display
      function updateCountDisplay() {
        if (!countElement) return;
        if (currentCount > 0) {
          countElement.textContent = `${currentCount} ${currentCount === 1 ? "heart" : "hearts"}`;
        } else {
          countElement.textContent = "â€”";
        }
      }

      // Handle heart click
      async function handleClick() {
        if (isSubmitting || !button) return;

        isSubmitting = true;
        button.disabled = true;
        button.classList.add("is-loading");

        // Add click animation
        heartIcon?.classList.add("is-clicked");
        setTimeout(() => {
          heartIcon?.classList.remove("is-clicked");
        }, 600);

        try {
          const response = await fetch("/api/hearts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ pageUrl }),
          });

          const data = await response.json();

          if (response.status === 429) {
            // Rate limited - show message from server
            const message =
              data.message || "Please wait before giving another heart";
            showMessage(message, "warning");
            if (data.count !== undefined) {
              currentCount = data.count;
              updateCountDisplay();
            }
          } else if (response.ok && data.success) {
            // Success
            currentCount = data.count || 0;
            updateCountDisplay();
            showMessage("Thank you! ðŸ’–", "success");
            heartIcon?.classList.add("is-success");
            setTimeout(() => {
              heartIcon?.classList.remove("is-success");
            }, 1000);
          } else {
            // Error
            showMessage("Failed to save heart. Please try again.", "error");
          }
        } catch (error) {
          console.error("Error saving heart:", error);
          showMessage("Network error. Please try again.", "error");
        } finally {
          isSubmitting = false;
          if (button) {
            button.disabled = false;
            button.classList.remove("is-loading");
          }
        }
      }

      // Show temporary message
      function showMessage(text: string, type: string) {
        const message = document.createElement("span");
        message.className = `heart-message heart-message--${type}`;
        message.textContent = text;
        component.appendChild(message);

        setTimeout(() => {
          message.classList.add("is-visible");
        }, 10);

        setTimeout(() => {
          message.classList.remove("is-visible");
          setTimeout(() => {
            message.remove();
          }, 300);
        }, 2000);
      }

      // Attach click handler
      button.addEventListener("click", handleClick);

      // Fetch initial count
      fetchCount();
    });
  });
</script>

<style>
  .give-heart {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
  }

  .give-heart-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: inherit;
    color: inherit;
  }

  .give-heart-button:hover:not(:disabled) {
    background: var(--color-surface-hover, #f9fafb);
    border-color: var(--color-border-hover, #d1d5db);
    transform: translateY(-1px);
  }

  .give-heart-button:active:not(:disabled) {
    transform: translateY(0);
  }

  .give-heart-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .give-heart-button.is-loading {
    opacity: 0.7;
  }

  .heart-icon {
    display: inline-block;
    font-size: 1.25rem;
    line-height: 1;
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  .heart-icon.is-clicked {
    animation: heartBounce 0.6s ease;
  }

  .heart-icon.is-success {
    animation: heartPulse 1s ease;
  }

  @keyframes heartBounce {
    0%,
    100% {
      transform: scale(1);
    }
    25% {
      transform: scale(1.3) rotate(-10deg);
    }
    50% {
      transform: scale(1.4) rotate(10deg);
    }
    75% {
      transform: scale(1.2) rotate(-5deg);
    }
  }

  @keyframes heartPulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }

  .give-heart-text {
    font-weight: 500;
  }

  .heart-count {
    font-variant-numeric: tabular-nums;
    color: var(--color-grey, #6b7280);
    min-width: 3ch;
    text-align: left;
  }

  .heart-message {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-surface, #fff);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    transform: translateY(-0.5rem);
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
    pointer-events: none;
    z-index: 10;
  }

  .heart-message.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .heart-message--success {
    border-color: var(--color-success, #10b981);
    color: var(--color-success, #10b981);
  }

  .heart-message--warning {
    border-color: var(--color-warning, #f59e0b);
    color: var(--color-warning, #f59e0b);
  }

  .heart-message--error {
    border-color: var(--color-error, #ef4444);
    color: var(--color-error, #ef4444);
  }

  .give-heart {
    position: relative;
  }
</style>
