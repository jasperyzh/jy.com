---
import Layout from "@/layouts/Layout.astro";

/**
 * ---
 * title: Creative Web Filter Guide
 * description: A breakdown of how this interactive webcam filter is built.
 * ---
 *
 * ## High-Level Overview
 *
 * This sketch captures a live webcam feed and overlays it with dynamic HTML and D3.js elements.
 * The final composition—video, UI elements, and data visualizations—can be captured and downloaded as a single PNG image.
 *
 * ## Core Technologies
 *
 * 1.  **p5.js**: Used for accessing the webcam and drawing the video feed onto a canvas element.
 * 2.  **D3.js**: Used for creating scalable data visualizations (SVG) on top of the video feed.
 * 3.  **html2canvas**: A library for capturing screenshots of DOM elements, used here to capture the HTML/D3 overlay.
 * 4.  **Astro**: The component-based framework this page is built with.
 * 5.  **Vanilla CSS**: Used for styling the layout and UI components.
 *
 * ## File Structure & Key Components
 *
 * The core of the sketch is built around a layered structure within the `#capture-wrapper` div:
 *
 * -   `#p5-container`: The base layer. The p5.js canvas, which renders the webcam video, is attached here.
 * -   `#html-overlay`: The top layer, positioned directly over the p5.js canvas. It contains all non-video UI, including:
 *     -   A mock API data display.
 *     -   An SVG "LIVE" sticker.
 *     -   The D3.js SVG canvas for data visualizations.
 *
 * ## JavaScript Logic Breakdown
 *
 * ### 1. p5.js Sketch (`sketch`)
 *
 * -   **Setup**: Initializes a canvas and accesses the user's webcam via `createCapture(p.VIDEO)`. The original video element is hidden, as we only need to draw its frames to the canvas. The `crossorigin: anonymous` attribute is set to prevent canvas tainting, which would block image exporting.
 * -   **Draw Loop**: In each frame, the video is drawn to the canvas. It is first flipped horizontally (`translate` and `scale`) to create a more intuitive "mirror" effect for the user. The code also calculates the correct aspect ratio to ensure the video covers the entire canvas without distortion.
 *
 * ### 2. D3.js Visualization (`setupD3`)
 *
 * -   An SVG element is appended to the `#html-overlay`.
 * -   A sample dataset is used to draw a pink circle.
 * -   A tooltip `div` is also appended to the `#html-overlay`. This is crucial because it ensures the tooltip is part of the element that `html2canvas` captures.
 * -   Event listeners (`mouseover`, `mousemove`, `mouseout`) are attached to the circle to control the tooltip's visibility and position. The position is calculated relative to the SVG container to ensure it appears correctly next to the cursor.
 *
 * ### 3. Image Capture & Download (`snapButton` event listener)
 *
 * This is a multi-step process triggered by clicking the "Snap & Download" button or pressing the 'S' key:
 *
 * 1.  **Capture p5.js Canvas**: The content of the p5.js canvas (the video frame) is converted into a PNG image format as a Data URL.
 * 2.  **Capture HTML Overlay**: `html2canvas` is used to take a "screenshot" of the `#html-overlay` div. Because all UI elements (D3 circle, tooltip, stickers) are inside this div, they are all captured. The `backgroundColor: null` option makes the screenshot's background transparent.
 * 3.  **Merge Images**: A new, temporary canvas is created. The p5.js image is drawn onto it first, followed by the overlay image on top.
 * 4.  **Trigger Download**: The content of the final merged canvas is converted to a Data URL and assigned to the `href` of a temporary link element. A click is programmatically triggered on the link, which opens the browser's "Save As" dialog.
 *
 * ### 4. Helper Scripts
 *
 * -   **Hotkey**: A global `keydown` event listener checks for the 'S' key to trigger the snap functionality.
 * -   **Mock API Data**: A `setInterval` function periodically updates the text content of the ticker element to simulate a live data feed.
 *
 */
---

<Layout title="Camera Sketch">
  <main>
    <h1>Creative Web Filter</h1>
    <p>Live webcam feed merged with a dynamic HTML overlay.</p>

    <!-- Wrapper for Canvas and HTML Overlay -->
    <div id="capture-wrapper">
      <!-- p5.js canvas will be attached here -->
      <div id="p5-container"></div>

      <!-- HTML Overlay -->
      <div id="html-overlay">
        <!-- Mock API Data -->
        <div id="mock-api-container">
          <p id="mock-api-data">TICKER: +3.14%</p>
        </div>

        <!-- SVG Sticker -->
        <div id="svg-sticker-container">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" fill="rgba(255, 223, 0, 0.8)" stroke="white" stroke-width="4"/>
            <text x="50" y="55" font-size="20" text-anchor="middle" alignment-baseline="middle" fill="black" font-family="sans-serif" font-weight="bold">LIVE</text>
          </svg>
        </div>
      </div>
    </div>

    <!-- Action Button -->
    <button id="snap-button">
      Snap & Download
    </button>
  </main>

  <style>
    main {
      max-width: 1280px;
      margin-left: auto;
      margin-right: auto;
      padding: 1rem;
      text-align: center;
    }
    h1 {
      font-size: 2.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    p {
      margin-bottom: 2rem;
    }
    #capture-wrapper {
      position: relative;
      width: 800px;
      height: 800px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    #p5-container, #html-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #html-overlay {
      color: white;
    }
    #mock-api-container {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 0.75rem;
      border-radius: 0.5rem;
      pointer-events: auto;
    }
    #mock-api-data {
      font-size: 1.5rem;
      font-family: monospace;
      margin: 0;
    }
    #svg-sticker-container {
      position: absolute;
      top: 1rem;
      left: 1rem;
      width: 6rem;
      height: 6rem;
      pointer-events: auto;
    }
    #snap-button {
      margin-top: 2rem;
      padding: 1rem 2rem;
      background-color: #2563eb;
      color: white;
      font-weight: 700;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #snap-button:hover {
      background-color: #1d4ed8;
    }
  </style>

  <!-- CDN for libraries -->
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script is:inline src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script is:inline src="https://d3js.org/d3.v7.min.js"></script>

  <script is:inline>
    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 800;

    let p5Canvas;
    let capture;

    // p5.js Sketch
    const sketch = (p) => {
      p.setup = () => {
        p5Canvas = p.createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
        p5Canvas.parent('p5-container');
        capture = p.createCapture(p.VIDEO);
        capture.elt.setAttribute('crossorigin', 'anonymous');
        capture.hide(); // Hide the original video element
      };

      p.draw = () => {
        p.push();
        p.translate(p.width, 0); // Move origin to top-right
        p.scale(-1, 1); // Flip horizontally

        // Calculate aspect ratio to cover the canvas
        const videoRatio = capture.width / capture.height;
        const canvasRatio = p.width / p.height;
        let drawWidth = p.width;
        let drawHeight = p.height;

        if (videoRatio > canvasRatio) {
            drawWidth = p.height * videoRatio;
        } else {
            drawHeight = p.width / videoRatio;
        }

        p.image(capture, (p.width - drawWidth) / 2, (p.height - drawHeight) / 2, drawWidth, drawHeight);
        p.pop();
      };
    };

    // D3 Visualization Setup
    const setupD3 = () => {
      const margin = { top: 20, right: 20, bottom: 30, left: 40 };
      const width = CANVAS_WIDTH - margin.left - margin.right;
      const height = CANVAS_HEIGHT - margin.top - margin.bottom;

      const htmlOverlay = d3.select("#html-overlay");

      const svg = htmlOverlay.append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

      const data = [{ cx: 150, cy: 100, r: 40, color: "rgba(255, 105, 180, 0.8)" }];

      // Append tooltip to the overlay so it gets captured
      const tooltip = htmlOverlay.append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("visibility", "hidden")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .style("color", "black")
        .style("pointer-events", "none");

      svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("cx", d => d.cx)
        .attr("cy", d => d.cy)
        .attr("r", d => d.r)
        .style("fill", d => d.color)
        .on("mouseover", function(event, d) {
          tooltip.style("visibility", "visible").text(`I'm a D3 circle!`);
        })
        .on("mousemove", function(event) {
          // Get mouse position relative to the SVG container
          const [mouseX, mouseY] = d3.pointer(event);
          tooltip.style("top", (mouseY - 10) + "px").style("left", (mouseX + 10) + "px");
        })
        .on("mouseout", function() {
          tooltip.style("visibility", "hidden");
        });
    };

    // Initialize p5.js
    new p5(sketch);

    // Initialize D3.js
    setupD3();

    // Snap, Merge, and Download Logic
    const snapButton = document.getElementById('snap-button');
    snapButton.addEventListener('click', async () => {
      try {
        // 1. Get p5.js canvas as a Data URL
        const p5Image = p5Canvas.elt.toDataURL('image/png');

        // 2. Capture the HTML overlay
        const overlayElement = document.getElementById('html-overlay');
        const overlayCanvas = await html2canvas(overlayElement, {
          backgroundColor: null, // Ensure transparency
          width: CANVAS_WIDTH,
          height: CANVAS_HEIGHT,
        });
        const overlayImage = overlayCanvas.toDataURL('image/png');

        // 3. Final Merge
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = CANVAS_WIDTH;
        finalCanvas.height = CANVAS_HEIGHT;
        const ctx = finalCanvas.getContext('2d');

        // Draw p5 base layer
        const baseImg = new Image();
        baseImg.onload = () => {
          ctx.drawImage(baseImg, 0, 0);

          // Draw overlay top layer
          const topImg = new Image();
          topImg.onload = () => {
            ctx.drawImage(topImg, 0, 0);

            // 4. Trigger Download
            const link = document.createElement('a');
            link.download = 'filter-snap.png';
            link.href = finalCanvas.toDataURL('image/png');
            link.click();
          };
          topImg.src = overlayImage;
        };
        baseImg.src = p5Image;

      } catch (error) {
        console.error('Oops, something went wrong!', error);
        alert('Could not generate image. Check console for errors.');
      }
    });

    // Add hotkey for snapping
    snapButton.textContent += " (S)"; // Update button text
    document.addEventListener('keydown', (event) => {
      if (event.key.toLowerCase() === 's') {
        snapButton.click();
      }
    });

    // Mock API data update
    const mockApiDataElement = document.getElementById('mock-api-data');
    setInterval(() => {
        const value = (Math.random() * 5).toFixed(2);
        const sign = Math.random() > 0.5 ? '+' : '-';
        mockApiDataElement.textContent = `TICKER: ${sign}${value}%`;
    }, 3000);

  </script>
</Layout>
