---
import Layout from "@/layouts/Layout.astro";

import { formatDateYYMMDD } from "@/util/util--date";

const title = `${formatDateYYMMDD(new Date())}--AudioMidiController`;
---

<Layout title={title}>
  <main>
    <header>
      <h1>{title}</h1>
    </header>

    <section id="status">
      <h2>Status</h2>
      <div>
        <p>Audio: <span id="status-audio">Initializing...</span></p>
        <p>MIDI: <span id="status-midi">Initializing...</span></p>
      </div>
    </section>

    <section id="audio-visualization">
      <h2>Audio Visualization</h2>
      <canvas id="audio-canvas"></canvas>
    </section>

    <section id="audio-data">
      <h2>Audio Data</h2>
      <div>
        <p>Volume: <span id="audio-volume">0.00</span></p>
        <p>Bass: <span id="audio-bass">0.00</span></p>
        <p>Mid: <span id="audio-mid">0.00</span></p>
        <p>Treble: <span id="audio-treble">0.00</span></p>
      </div>
    </section>

    <section id="midi-data">
      <h2>MIDI Data</h2>
      <div>
        <p>Active Notes: <span id="midi-notes">None</span></p>
        <p>Velocity: <span id="midi-velocity">0</span></p>
        <p>Pitch Bend: <span id="midi-pitchbend">0.00</span></p>
        <div>
          <p>CC Values:</p>
          <pre id="midi-cc">None</pre>
        </div>
      </div>
    </section>

    <section id="midi-devices">
      <h2>MIDI Devices</h2>
      <ul id="midi-devices-list">
        <li>No devices connected</li>
      </ul>
    </section>

    <section id="controls">
      <h2>Controls</h2>
      <div>
        <button id="btn-start">Start</button>
        <button id="btn-stop">Stop</button>
      </div>
    </section>

    <section id="documentation">
      <h2>Documentation</h2>
      
      <h3>How It Works</h3>
      <p>
        AudioMIDIController uses the Web Audio API to capture audio input (microphone or line-in)
        and the Web MIDI API to receive MIDI messages from connected devices (keyboards, controllers, etc.).
        The audio is analyzed using FFT (Fast Fourier Transform) to extract frequency bands (bass, mid, treble)
        and overall volume. MIDI messages are parsed to extract note events, control changes, and pitch bend.
      </p>

      <h3>Basic Setup</h3>
      <pre><code>import AudioMIDIController from "/dailies/AudioMIDIController.js";

const controller = new AudioMIDIController({"{"}
  enableAudio: true,
  enableMIDI: true,
  smoothing: 0.8,
{"}"});

await controller.init();
controller.start();</code></pre>

      <h3>Getting Data</h3>
      <pre><code>// In your draw/animation loop
const audioData = controller.getAudioData();
// {"{"} volume: 0-1, bass: 0-1, mid: 0-1, treble: 0-1 {"}"}

const midiData = controller.getMIDIData();
// {"{"} activeNotes: [], velocity: 0-127, cc: {"{}"}, pitchBend: -1 to 1 {"}"}</code></pre>

      <h3>Audio Visualization</h3>
      <pre><code>import AudioVisualizer from "/dailies/AudioVisualizer.js";

const canvas = document.getElementById("audio-canvas");
const visualizer = new AudioVisualizer(canvas, {"{"}
  showOscillator: true,
  showBars: true,
{"}"});

// In animation loop
const audioData = controller.getAudioData();
visualizer.update(audioData);
visualizer.draw();</code></pre>

      <h3>Reacting to Audio</h3>
      <pre><code>function draw() {"{"}
  if (controller.isAudioReady()) {"{"}
    const audio = controller.getAudioData();
    
    // Map volume to parameter
    sketchConfig.noiseScale = 0.05 + (audio.volume * 0.5);
    
    // Map bass to size
    sketchConfig.dotSize = 1.0 + (audio.bass * 2.0);
  {"}"}
{"}"}</code></pre>

      <h3>Reacting to MIDI</h3>
      <pre><code>function draw() {"{"}
  if (controller.isMIDIReady()) {"{"}
    const midi = controller.getMIDIData();
    
    // Change size based on note count
    if (midi.activeNotes.length > 0) {"{"}
      const sizes = [4, 8, 16, 32, 64];
      sketchConfig.matrixSize = sizes[midi.activeNotes.length - 1] || 4;
    {"}"}
    
    // Use velocity for speed
    sketchConfig.speed = 0.002 + (midi.velocity / 127) * 0.05;
    
    // Use CC values
    if (midi.cc[1] !== undefined) {"{"}
      sketchConfig.brightness = midi.cc[1] / 127;
    {"}"}
  {"}"}
{"}"}</code></pre>

      <h3>Browser Compatibility</h3>
      <ul>
        <li><strong>Web Audio API</strong>: Supported in all modern browsers</li>
        <li><strong>Web MIDI API</strong>: Chrome, Edge, Opera (Firefox requires user script)</li>
      </ul>

      <h3>Troubleshooting</h3>
      <ul>
        <li>If audio doesn't work: Check browser permissions, ensure microphone is connected</li>
        <li>If MIDI doesn't work: Check browser support, ensure MIDI device is connected</li>
        <li>Use <code>controller.isAudioReady()</code> and <code>controller.isMIDIReady()</code> to check status</li>
      </ul>
    </section>
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    font-family: system-ui, -apple-system, sans-serif;
    line-height: 1.6;
  }

  header {
    margin-bottom: 2rem;
  }

  h1 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  h2 {
    font-size: 1.25rem;
    font-weight: bold;
    margin-top: 2rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.5rem;
  }

  h3 {
    font-size: 1.1rem;
    font-weight: bold;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  section {
    margin-bottom: 2rem;
  }

  #audio-canvas {
    width: 100%;
    height: 200px;
    border: 1px solid #ccc;
    display: block;
  }

  pre {
    background: #f5f5f5;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 0.875rem;
  }

  code {
    font-family: 'Courier New', monospace;
  }

  button {
    padding: 0.5rem 1rem;
    margin-right: 0.5rem;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
    font-size: 1rem;
  }

  button:hover {
    background: #f5f5f5;
  }

  button:active {
    background: #e0e0e0;
  }

  ul {
    list-style: disc;
    padding-left: 1.5rem;
  }

  li {
    margin-bottom: 0.25rem;
  }
</style>

<script type="module">
  import AudioMIDIController from "/dailies/AudioMIDIController.js";
  import AudioVisualizer from "/dailies/AudioVisualizer.js";

  // DOM elements
  const els = {
    statusAudio: document.getElementById("status-audio"),
    statusMidi: document.getElementById("status-midi"),
    audioVolume: document.getElementById("audio-volume"),
    audioBass: document.getElementById("audio-bass"),
    audioMid: document.getElementById("audio-mid"),
    audioTreble: document.getElementById("audio-treble"),
    midiNotes: document.getElementById("midi-notes"),
    midiVelocity: document.getElementById("midi-velocity"),
    midiPitchBend: document.getElementById("midi-pitchbend"),
    midiCC: document.getElementById("midi-cc"),
    midiDevicesList: document.getElementById("midi-devices-list"),
    btnStart: document.getElementById("btn-start"),
    btnStop: document.getElementById("btn-stop"),
    audioCanvas: document.getElementById("audio-canvas"),
  };

  // State
  let controller = null;
  let visualizer = null;
  let animationFrameId = null;
  let isRunning = false;

  // Initialize
  async function init() {
    try {
      controller = new AudioMIDIController({
        enableAudio: true,
        enableMIDI: true,
        smoothing: 0.8,
      });

      await controller.init();
      controller.start();
      isRunning = true;

      // Initialize visualizer
      visualizer = new AudioVisualizer(els.audioCanvas, {
        showOscillator: true,
        showBars: true,
      });

      // Start update loop
      updateLoop();

      // Update device list
      updateMIDIDevices();

      console.log("AudioMIDI Controller initialized");
    } catch (error) {
      console.error("Initialization failed:", error);
      els.statusAudio.textContent = "Error: " + error.message;
      els.statusMidi.textContent = "Error: " + error.message;
    }
  }

  // Update loop
  function updateLoop() {
    if (!isRunning) return;

    // Update status
    els.statusAudio.textContent = controller.isAudioReady() ? "Ready" : "Not Ready";
    els.statusMidi.textContent = controller.isMIDIReady() ? "Ready" : "Not Ready";

    // Update audio data
    if (controller.isAudioReady()) {
      const audio = controller.getAudioData();
      els.audioVolume.textContent = audio.volume.toFixed(2);
      els.audioBass.textContent = audio.bass.toFixed(2);
      els.audioMid.textContent = audio.mid.toFixed(2);
      els.audioTreble.textContent = audio.treble.toFixed(2);

      // Update visualizer
      if (visualizer) {
        visualizer.update(audio);
        visualizer.draw();
      }
    }

    // Update MIDI data
    if (controller.isMIDIReady()) {
      const midi = controller.getMIDIData();
      
      if (midi.activeNotes.length > 0) {
        els.midiNotes.textContent = midi.activeNotes.join(", ");
      } else {
        els.midiNotes.textContent = "None";
      }

      els.midiVelocity.textContent = midi.velocity;
      els.midiPitchBend.textContent = midi.pitchBend.toFixed(2);

      const ccKeys = Object.keys(midi.cc);
      if (ccKeys.length > 0) {
        const ccText = ccKeys.map(k => `CC ${k}: ${midi.cc[k]}`).join("\n");
        els.midiCC.textContent = ccText;
      } else {
        els.midiCC.textContent = "None";
      }
    }

    animationFrameId = requestAnimationFrame(updateLoop);
  }

  // Update MIDI devices list
  function updateMIDIDevices() {
    if (!controller || !controller.isMIDIReady()) {
      els.midiDevicesList.innerHTML = "<li>No devices connected</li>";
      return;
    }

    const devices = controller.getMIDIDevices();
    if (devices.length === 0) {
      els.midiDevicesList.innerHTML = "<li>No devices connected</li>";
    } else {
      els.midiDevicesList.innerHTML = devices
        .map(device => `<li>${device}</li>`)
        .join("");
    }
  }

  // Controls
  els.btnStart.addEventListener("click", async () => {
    if (!controller) {
      await init();
    } else if (!isRunning) {
      controller.start();
      isRunning = true;
      updateLoop();
    }
  });

  els.btnStop.addEventListener("click", () => {
    if (controller && isRunning) {
      controller.stop();
      isRunning = false;
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    }
  });

  // Initialize on load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>
