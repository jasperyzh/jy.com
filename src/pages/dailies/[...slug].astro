---
/**
 * @description Dynamic route for individual sketch pages
 * 
 * HOW IT WORKS:
 * =============
 * 
 * 1. STATIC PATH GENERATION (getStaticPaths)
 *    - Uses Astro's getStaticPaths() to generate routes at build time
 *    - Scans all .astro files in src/sketches/ using import.meta.glob()
 *    - Parses metadata from filenames following format: YYMMDD-sketch--(title)
 *    - Creates a route for each sketch at /dailies/[slug]
 * 
 * 2. FILENAME PARSING
 *    - Expected format: YYMMDD-sketch--(sketch_name)
 *    - Example: "251128-sketch--Fire & Water.astro" or "251128-sketch--Fire%20&%20Water.astro"
 *    - Extracts:
 *      * sketch_date: "251128" (first 6 digits)
 *      * sketch_title: "Fire & Water" (everything after "sketch--", URL-decoded)
 *      * slug: Used in URL (currently uses sketch_date for cleaner URLs like /dailies/251128)
 * 
 * 3. URL DECODING & NORMALIZATION
 *    - Decodes URL-encoded characters (e.g., %20 -> space, %26 -> &)
 *    - Converts spaces to underscores in filenames for cleaner URLs
 *    - Example: "Fire%20&%20Water" -> "Fire_&_Water" (in title) -> "251128" (in slug)
 * 
 * 4. ROUTE GENERATION
 *    - Each sketch gets a route: /dailies/[slug]
 *    - Props passed to the page component:
 *      * SketchComponent: The actual sketch component to render
 *      * filename: Full filename without extension (URL-decoded)
 *      * sketch_date: YYMMDD date string
 *      * sketch_title: Title extracted from filename (URL-decoded, spaces preserved)
 *      * canvas_width/canvas_height: Canvas dimensions (defaults to 800x800)
 * 
 * 5. RENDERING
 *    - The SketchComponent is rendered directly
 *    - Sketch files use LayoutDailies, which provides the layout structure
 *    - All sketches are pre-rendered at build time (prerender: true)
 * 
 * 6. SORTING
 *    - Sketches are sorted by date (newest first) before returning paths
 * 
 * NOTE: If multiple sketches share the same date, they will conflict.
 * Consider using unique identifiers or timestamps if needed.
 */

export async function getStaticPaths() {
  // Import all sketch files from src/sketches/
  // Use eager: true to get modules directly and avoid dynamic import issues
  const allSketches = import.meta.glob("../../sketches/*.astro", {
    eager: true,
  });

  const paths: Array<{
    params: { slug: string };
    props: {
      SketchComponent: any;
      filename: string;
      sketch_date: string;
      sketch_title: string;
      canvas_width: number;
      canvas_height: number;
    };
  }> = [];

  /**
   * Parse sketch metadata from filename
   * Expected format: YYMMDD-sketch--(sketch_name)
   * Handles URL-encoded filenames (e.g., %20 for spaces, %26 for &)
   * @param {string} filename - Filename without extension (may be URL-encoded)
   * @returns {{sketch_date: string, sketch_title: string, slug: string}}
   */
  function parseSketchMeta(filename) {
    if (!filename) return { sketch_date: "", sketch_title: "", slug: "" };

    // Decode URL encoding first to get original characters
    const decodedFilename = decodeURL(filename);

    // Match: YYMMDD-sketch--(sketch_name)
    // Captures: date (6 digits) and title (everything after "sketch--")
    const match = decodedFilename.match(/^(\d{6})-sketch--(.+)$/);

    if (!match) {
      // Only warn if it looks like it might be a sketch file (contains "sketch" or starts with digits)
      // This prevents warnings for unrelated files like consts.ts
      if (decodedFilename.includes("sketch") || /^\d/.test(decodedFilename)) {
        console.warn(
          `Filename "${filename}" (decoded: "${decodedFilename}") does not match expected format: YYMMDD-sketch--(sketch_name)`
        );
      }
      return { sketch_date: "", sketch_title: "", slug: "" };
    }

    const sketch_date = match[1]; // YYMMDD
    const sketch_title = match[2]; // Title with spaces and special chars preserved (e.g., "Fire & Water")

    return {
      sketch_date,
      sketch_title,
      slug: sketch_date, // Use only date (YYMMDD) as slug for cleaner URLs like /dailies/251128
    };
  }

  /**
   * Extract filename from file path
   * @param {string} filePath - Full file path
   * @returns {string} Filename without extension
   */
  function getFilenameFromPath(filePath) {
    const filename = filePath.split("/").pop() || "";
    return filename.replace(/\.astro$/, "");
  }

  /**
   * Decode URL-encoded string
   * Handles %20 (space), %26 (&), and other URL-encoded characters
   * @param {string} str - URL-encoded string
   * @returns {string} Decoded string
   */
  function decodeURL(str) {
    if (!str) return "";
    
    try {
      return decodeURIComponent(str);
    } catch (e) {
      // If decoding fails, manually replace common encodings
      return str
        .replace(/%20/g, " ")
        .replace(/%26/g, "&")
        .replace(/%2F/g, "/")
        .replace(/%3F/g, "?")
        .replace(/%3D/g, "=");
    }
  }

  /**
   * Normalize filename: decode URL encoding and convert spaces to underscores
   * @param {string} filename - Filename (may be URL-encoded)
   * @returns {string} Decoded filename with spaces as underscores
   */
  function normalizeFilename(filename) {
    const decoded = decodeURL(filename);
    return decoded.replace(/\s+/g, "_");
  }


  // Loop through all sketches and generate paths
  for (const filePath in allSketches) {
    // Early filter: only process files from sketches directory that end with .astro
    // This prevents processing unexpected files like consts.ts
    if (!filePath.includes("/sketches/") || !filePath.endsWith(".astro")) {
      continue;
    }

    const rawFilename = getFilenameFromPath(filePath);
    const { sketch_date, sketch_title, slug } = parseSketchMeta(rawFilename);

    // Skip if filename doesn't match expected format
    if (!sketch_date || !sketch_title) {
      continue;
    }

    // Get the module (already loaded with eager: true)
    const SketchModule = allSketches[filePath] as any;
    const SketchComponent = SketchModule.default;

    // Extract canvas dimensions from the sketch if available, or use defaults
    const canvas_width = SketchModule.canvas_width || 800;
    const canvas_height = SketchModule.canvas_height || 800;

    // Normalize filename for props (spaces converted to underscores)
    const normalizedFilename = normalizeFilename(rawFilename);

    paths.push({
      params: { slug: slug },
      props: {
        SketchComponent,
        filename: normalizedFilename, // Filename with spaces as underscores (e.g., "Fire_&_Water")
        sketch_date,
        sketch_title, // Title with spaces preserved for display (e.g., "Fire & Water")
        canvas_width,
        canvas_height,
      },
    });
  }

  // Sort by date (newest first)
  paths.sort((a, b) => {
    const dateA = a.props.sketch_date;
    const dateB = b.props.sketch_date;
    return dateB.localeCompare(dateA);
  });

  return paths;
}

const {
  SketchComponent,
  filename,
  sketch_date,
  sketch_title,
  canvas_width,
  canvas_height,
} = Astro.props;

export const prerender = true;
---

<!-- 
  The sketch component is rendered directly here.
  Sketch files use DailiesInstance, which is a wrapper around LayoutDailies,
  so they will work correctly with this setup.
-->
<SketchComponent />
