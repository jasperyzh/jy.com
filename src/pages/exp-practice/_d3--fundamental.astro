---
// Component for D3 visualizations
---

<section class="my-8">
  <h2 class="text-3xl font-bold mb-4">
    Interactive Visualization of D3 Concepts
  </h2>
  <p>
    The following is an interactive force-directed graph created with
    D3.js that visualizes the key topics discussed in this article. You
    can drag the nodes around to see how they interact. This is a great
    way to get a feel for how D3.js works in practice.
  </p>
  <div
    id="d3-container"
    class="w-full  border border-gray-300 rounded-lg"
  >
  </div>
  <button
    id="save-svg-button"
    class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
  >
    Save as SVG
  </button>

  <script is:inline src="https://d3js.org/d3.v7.min.js"></script>
  <script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
      // const width = document.getElementById('d3-container').clientWidth;
      // const height = window.innerHeight;
      const width = 800;
      const height = 800;
      const data = {
        nodes: [
          { id: "D3.js Fundamentals", group: 1, size: 20 },
          { id: "SVG Primitives", group: 2, size: 12 },
          { id: "D3 Selections and Data Binding", group: 2, size: 12 },
          {
            id: "Data-to-Visual Mapping with Scales",
            group: 2,
            size: 12,
          },
          { id: "Interactivity and Performance", group: 2, size: 12 },
          { id: "Visualization Ecosystem", group: 3, size: 12 },
          { id: "Design and Analysis", group: 3, size: 12 },
          { id: "Practical Examples", group: 4, size: 12 },
          { id: "Related Concepts", group: 4, size: 12 },
          { id: "Key Questions/Challenges", group: 5, size: 12 },
          { id: "Fun Insights", group: 5, size: 12 },
          { id: "Discussed Topics & Highlights", group: 5, size: 12 },
        ],
        links: [
          {
            source: "D3.js Fundamentals",
            target: "SVG Primitives",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "D3 Selections and Data Binding",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Data-to-Visual Mapping with Scales",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Interactivity and Performance",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Visualization Ecosystem",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Design and Analysis",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Practical Examples",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Related Concepts",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Key Questions/Challenges",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Fun Insights",
            value: 1,
          },
          {
            source: "D3.js Fundamentals",
            target: "Discussed Topics & Highlights",
            value: 1,
          },
        ],
      };

      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const svg = d3
        .select("#d3-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height])
        .attr(
          "style",
          "max-width: 100%; height: auto; background: #eaeaea"
        );

      const simulation = d3
        .forceSimulation(data.nodes)
        .force(
          "link",
          d3
            .forceLink(data.links)
            .id((d) => d.id)
            .distance(200)
        )
        .force("charge", d3.forceManyBody().strength(-1000))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg
        .append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(data.links)
        .enter()
        .append("line")
        .attr("class", "link")
        .style("stroke", "#999")
        .style("stroke-opacity", 0.5)
        .attr("stroke-width", (d) => Math.sqrt(d.value));

      const node = svg
        .append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(data.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

      node
        .append("circle")
        .attr("r", (d) => d.size)
        .attr("fill", (d) => color(d.group));

      node
        .append("text")
        .attr("dx", 16)
        .attr("dy", ".35em")
        .text((d) => d.id)
        .style("font-size", "12px")
        .style("fill", "#333");

      simulation.on("tick", () => {
        link
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);

        node.attr("transform", (d) => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      document
        .getElementById("save-svg-button")
        .addEventListener("click", function () {
          const svgEl = svg.node();
          svgEl.setAttribute("xmlns", "http://www.w3.org/2000/svg");
          const svgData = svgEl.outerHTML;
          const preface = '<?xml version="1.0" standalone="no"?>\r\n';
          const svgBlob = new Blob([preface, svgData], {
            type: "image/svg+xml;charset=utf-8",
          });
          const svgUrl = URL.createObjectURL(svgBlob);
          const downloadLink = document.createElement("a");
          downloadLink.href = svgUrl;
          downloadLink.download = "d3-visualization.svg";
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
    });
  </script>
</section>

<section class="my-8">
  <h1 class="text-2xl font-bold mb-2">
    Malaysian Population by Ethnicity (1970-2022)
  </h1>
  <p class="text-sm text-gray-600 mb-4">
    A multi-series line chart showing population trends for different ethnic
    groups over the years.
  </p>
  <div id="visualization"></div>
  <a href="https://data.gov.my/data-catalogue/population_malaysia">source: data.gov.my â€” Population Table: Malaysia</a>
</section>

<style>
  .tooltip {
    position: absolute;
    text-align: center;
    padding: 8px;
    font: 12px sans-serif;
    background: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 8px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
</style>

<script is:inline src="https://d3js.org/d3.v7.min.js"></script>
<script is:inline>
  const fetchData = async () => {
    try {
      const requestOptions = {
        method: "GET",
        redirect: "follow",
      };
      // Fetch a larger dataset to cover the time series
      const response = await fetch(
        "https://api.data.gov.my/data-catalogue?id=population_malaysia",
        requestOptions
      );
      const data = await response.json();
      createChart(data);
    } catch (error) {
      console.log("error", error);
      d3.select("#visualization").text("Error loading data.");
    }
  };

  const createChart = (data) => {
    // Step 1: Filter and prepare data for ethnicity time series
    const ethnicData = data
      .filter(
        (d) =>
          d.age === "overall" && d.sex === "both" && d.ethnicity !== "overall"
      )
      .map((d) => ({
        date: d3.timeParse("%Y-%m-%d")(d.date),
        ethnicity: d.ethnicity,
        population: d.population / 1000, // Convert to thousands
      }));

    // Group data by ethnicity to create multiple series
    const seriesData = d3.group(ethnicData, (d) => d.ethnicity);

    // Extract all dates and population values for scaling
    const allDates = ethnicData.map(d => d.date);
    const allPopulations = ethnicData.map(d => d.population);

    // Step 2: Define Scales and Axes
    const margin = { top: 20, right: 120, bottom: 50, left: 70 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    const svg = d3
      .select("#visualization")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // X-axis: Time Scale
    const xScale = d3.scaleTime().domain(d3.extent(allDates)).range([0, width]);

    // Y-axis: Linear Scale (Population)
    const yScale = d3
      .scaleLinear()
      .domain([0, d3.max(allPopulations)])
      .nice()
      .range([height, 0]);

    // Color Scale: Ordinal Scale for Ethnicities
    const colorScale = d3
      .scaleOrdinal()
      .domain(Array.from(seriesData.keys()))
      .range(d3.schemeCategory10);

    // Line Generator
    const lineGenerator = d3
      .line()
      .x((d) => xScale(d.date))
      .y((d) => yScale(d.population));

    // Step 3: Create SVG and Axes
    // Append X Axis
    svg
      .append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")));

    // Append Y Axis
    svg.append("g").call(d3.axisLeft(yScale));

    // Y-Axis Label
    svg
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left + 20)
      .attr("x", 0 - height / 2)
      .style("text-anchor", "middle")
      .text("Population (in Thousands)");

    // Tooltip
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    const handleMouseOver = (event, d) => {
      tooltip.transition().style("opacity", 0.9);
      tooltip
        .html(
          `<strong>${d.ethnicity.replace('bumi_malay', 'Malay').replace('bumi_other', 'Other Bumiputera').replace('other_noncitizen', 'Non-Citizen')}</strong><br/>
           Year: ${d.date.getFullYear()}<br/>
           Population: ${d3.format(",.0f")(d.population * 1000)}`
        )
        .style("left", event.pageX + 15 + "px")
        .style("top", event.pageY - 28 + "px");
    };

    const handleMouseOut = () => {
      tooltip.transition().style("opacity", 0);
    };

    // Step 4: Draw the Lines
    const ethnicityGroups = svg
      .selectAll(".ethnicity-group")
      .data(seriesData)
      .join("g")
      .attr("class", "ethnicity-group");

    ethnicityGroups
      .append("path")
      .attr("fill", "none")
      .attr("stroke", (d) => colorScale(d[0]))
      .attr("stroke-width", 2)
      .attr("d", (d) => lineGenerator(d[1]));

    // Add circles for tooltips
    ethnicityGroups
      .selectAll("circle")
      .data((d) => d[1])
      .join("circle")
      .attr("cx", (d) => xScale(d.date))
      .attr("cy", (d) => yScale(d.population))
      .attr("r", 3)
      .attr("fill", (d) => colorScale(d.ethnicity))
      .on("mouseover", handleMouseOver)
      .on("mouseout", handleMouseOut);

    // Step 5: Add a Legend
    const legend = svg
      .append("g")
      .attr("transform", `translate(${width + 20}, 0)`);

    legend
      .selectAll("rect")
      .data(Array.from(seriesData.keys()))
      .join("rect")
      .attr("x", 0)
      .attr("y", (d, i) => i * 20)
      .attr("width", 10)
      .attr("height", 10)
      .attr("fill", (d) => colorScale(d));

    legend
      .selectAll("text")
      .data(Array.from(seriesData.keys()))
      .join("text")
      .attr("x", 15)
      .attr("y", (d, i) => i * 20 + 9)
      .text((d) =>
        d
          .replace("bumi_malay", "Malay")
          .replace("bumi_other", "Other Bumiputera")
          .replace("chinese", "Chinese")
          .replace("indian", "Indian")
          .replace("other_citizen", "Other Citizen")
          .replace("other_noncitizen", "Non-Citizen")
      )
      .style("font-size", "12px");
  };

  fetchData();
</script>

