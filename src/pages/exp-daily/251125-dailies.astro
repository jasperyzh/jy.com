---
import Layout from "@/layouts/Layout.astro";

import { formatDateYYMMDD } from "@/util/util--date";

// Import the sketch component - this will set up createDotMatrixSketch globally
import SketchSetup from "./_251125-sketch-dotMatrixSketch.astro";

const sketch_name = "long live the rain";

const today_date = formatDateYYMMDD(new Date());

const title = `${today_date}-dailies${sketch_name ? `--${sketch_name}` : ""}`;

const footer_text = `${today_date} // FRAMEWORK_V2 // OPEN  -METEO API // P5.JS`;

const canvas_width = 1024;
const canvas_height = 768;
---

<Layout title={title} empty_canvas={true}>
  <main class="flex flex-col gap-4 max-w-[800px]">
    <!-- Main Container -->
    <!-- Header / Controls -->
    <header>
      <h1 class="h5">{title}</h1>
      <div class="flex gap-2">
        <button id="btn-export-svg">Export SVG</button>
        <button id="btn-export-png">Export PNG</button>
      </div>
    </header>

    <!-- Sketch Frame (The Capture Area) -->
    <div id="sketch-frame" class="grid-- grid--content_sidebar">
      <!-- Back -->
      <section class="back">
        <img
          class="w-full h-full object-cover object-bottom col-span-2 row-span-2"
          src="/assets/Blog__/251124-20251124_140919.jpg"
          alt=""
        />
        <span>TEMP</span>
        <span id="data-temp" class="text-2xl animated--">--°C</span>
        <span>WIND</span>
        <span id="data-wind" class="animated--">-- km/h</span>
      </section>

      <!-- middle -->
      <section class="middle">
        <div id="canvas-container"></div>
      </section>

      <!-- Top  -->
      <section class="front">
        <span id="data-location" class="animated--">LOADING...</span>
        <span id="data-coords" class="animated--">--°N --°E</span>
        <span id="data-time" class="animated--">00:00:00</span>
      </section>
    </div>

    <!-- footer -->
    <footer class="font-display-alt">
      {footer_text}
    </footer>
  </main>
</Layout>

<style
  define:vars={{
    canvas_width: canvas_width + "px",
    canvas_height: canvas_height + "px",
  }}
>
  #sketch-frame {
    width: var(--canvas_width);
    height: var(--canvas_height);
    aspect-ratio: 1/1;
    margin: 0 auto;
    background-color: var(--color-yellow);

    & > * {
      grid-column: 1;
      grid-row: 1;
    }
    & > .front,
    & > .back {
      display: grid;
      grid-template-columns: subgrid;
      grid-template-rows: repeat(5, 20%);
      grid-column: 1 / -1;
      grid-row: 1 / -1;
      padding: 3rem;
    }
    header {
      display: flex;
      flex-direction: column;
    }
    footer {
      text-align: center;
      color: var(--color-greylight);
      font-size: 0.875rem;
      font-family: var(--font-mono);
      margin-top: 1rem;
    }

    .front {
      color: var(--color-2a) !important;
      font-size: var(--text-5xl);
      font-family: var(--font-display);
      font-weight: bold;
    }
    .middle {
    }
    .back {
      color: var(--color-red) !important;
      font-size: var(--text-5xl);
      font-family: var(--font-display);
      font-weight: bold;
    }
  }
</style>

<!-- Libraries -->
<script type="module">
  import "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.10/p5.js";
  import "https://cdn.jsdelivr.net/npm/p5.js-svg@1.6.0/dist/p5.svg.min.js";
  import "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
</script>

<script
  is:inline
  type="module"
  define:vars={{ title, canvas_width, canvas_height }}
>
  import GUI from "https://cdn.jsdelivr.net/npm/lil-gui@0.19/+esm";
  import PixelDisplay from "/dailies/PixelDisplay.js";
  import AudioMIDIController from "/dailies/AudioMIDIController.js";

  // --- CONFIGURATION ---
  const CONFIG = {
    debug: true,
    city: "Kuala Lumpur", // Default city
    lat: 3.0831022768590155,
    lon: 101.64836391773572,
    refreshRate: 1000 * 60 * 15, // 15 mins

    // Dimensions
    width: canvas_width,
    height: canvas_height,

    // Dot Matrix Params (simplified)
    matrixSize: 4,
    theme: "milk_transparent",
    noiseScale: 0.05,
    dotScaleFactor: 2.0,
    animationSpeed: 0.002,

    // Common
    isPaused: false,

    // Export
    exportSize: "current", // 'current' | 'a4'

    // Audio/MIDI
    enableAudio: true,
    enableMIDI: true,
    audioNoiseScaleSensitivity: 0.5,
    audioDotScaleSensitivity: 1.0,
    midiAnimationSpeedSensitivity: 0.05,
    midiMatrixSizeSensitivity: true,
  };

  // --- STATE ---
  let weatherData = null;

  let sketch = null;
  let audioMIDIController = null;

  // --- DOM ELEMENTS ---
  const els = {
    location: document.getElementById("data-location"),
    coords: document.getElementById("data-coords"),
    time: document.getElementById("data-time"),
    temp: document.getElementById("data-temp"),
    wind: document.getElementById("data-wind"),
    frame: document.getElementById("sketch-frame"),
  };

  // --- DATA LAYER ---
  async function fetchWeather() {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.lat}&longitude=${CONFIG.lon}&current=temperature_2m,wind_speed_10m&timezone=auto`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.current) {
        weatherData = data.current;
        updateUI();
      }
    } catch (e) {
      console.error("Weather fetch failed", e);
    }
  }

  function updateUI() {
    if (!weatherData) return;
    els.location.textContent = CONFIG.city.toUpperCase();
    els.coords.textContent = `${CONFIG.lat.toFixed(2)}°N ${CONFIG.lon.toFixed(2)}°E`;
    els.temp.textContent = `${weatherData.temperature_2m}${weatherData.temperature_2m_unit || "°C"}`;
    els.wind.textContent = `${weatherData.wind_speed_10m} km/h`;
  }

  function updateTime() {
    const now = new Date();
    els.time.textContent = now.toLocaleTimeString("en-US", {
      hour12: false,
    });
  }

  // --- LAYOUT CONTROL ---
  function updateLayout() {
    els.frame.style.width = `${CONFIG.width}px`;
    els.frame.style.height = `${CONFIG.height}px`;

    // Reset dot matrix
    if (sketch && sketch.resize) {
      sketch.resize(CONFIG.width, CONFIG.height);
    }

    if (sketch && sketch.updateColorTheme) {
      sketch.updateColorTheme();
    }
  }

  function updateColorTheme() {
    if (sketch && sketch.updateColorTheme) {
      sketch.updateColorTheme();
    }
  }

  // --- AUDIO/MIDI CONTROLLER ---
  async function initAudioMIDI() {
    try {
      audioMIDIController = new AudioMIDIController({
        enableAudio: CONFIG.enableAudio,
        enableMIDI: CONFIG.enableMIDI,
        smoothing: 0.8,
      });

      await audioMIDIController.init();

      // Connect to sketch if it exists
      if (sketch && sketch.setAudioMIDIController) {
        sketch.setAudioMIDIController(audioMIDIController);
      }

      // Start processing
      audioMIDIController.start();

      console.log("Audio/MIDI controller initialized");
    } catch (error) {
      console.warn("Audio/MIDI initialization failed:", error);
    }
  }

  function updateAudioMIDISettings() {
    // Sensitivity settings are read dynamically from CONFIG in the sketch
    // No need to restart, they're applied each frame
  }

  // --- P5 SKETCH (Global Mode) ---
  window.setup = function () {
    // Use the global function directly - no adapter needed!
    // Pass audio/MIDI sensitivity settings to sketch
    const sketchConfig = {
      ...CONFIG,
      audioNoiseScaleSensitivity: CONFIG.audioNoiseScaleSensitivity,
      audioDotScaleSensitivity: CONFIG.audioDotScaleSensitivity,
      midiAnimationSpeedSensitivity: CONFIG.midiAnimationSpeedSensitivity,
      midiMatrixSizeSensitivity: CONFIG.midiMatrixSizeSensitivity,
    };
    // sketch = window.createDotMatrixSketch(sketchConfig);
    sketch = window.createDotMatrixSketch(CONFIG);

    // Initialize dependencies
    sketch.init(PixelDisplay);

    // Connect audio/MIDI controller if available
    if (audioMIDIController && sketch.setAudioMIDIController) {
      sketch.setAudioMIDIController(audioMIDIController);
    }

    // Setup the sketch
    sketch.setup();

    // Set canvas parent
    const canvasEl = document.getElementById("defaultCanvas0");
    if (canvasEl) {
      canvasEl.parentElement.removeChild(canvasEl);
      document.getElementById("canvas-container").appendChild(canvasEl);
    }
  };

  window.draw = function () {
    if (sketch && sketch.draw) {
      sketch.draw();
    }
  };

  // --- EXPORT FUNCTIONS ---

  // --- INIT ---
  async function init() {
    // 1. Initialize Audio/MIDI Controller
    await initAudioMIDI();

    // 2. Start Data Fetching
    fetchWeather();
    setInterval(fetchWeather, CONFIG.refreshRate);
    setInterval(updateTime, 1000);
    updateTime();

    // 3. Setup GUI
    const gui = new GUI();

    const f0 = gui.addFolder("Layout");
    f0.add(CONFIG, "width", 400, 2000).step(10).onChange(updateLayout);
    f0.add(CONFIG, "height", 400, 2000).step(10).onChange(updateLayout);

    const f1 = gui.addFolder("Sketch");
    f1.add(CONFIG, "matrixSize", [64, 32, 16, 8, 4])
      .name("Matrix Size")
      .onChange(updateLayout);
    f1.add(CONFIG, "theme", [
      "2a",
      "milk_transparent",
      "green",
      "amber",
      "white",
      "blue",
    ])
      .name("Theme")
      .onChange(updateColorTheme);
    f1.add(CONFIG, "noiseScale", 0.01, 0.8, 0.005).name("Noise Scale (Base)");
    f1.add(CONFIG, "animationSpeed", 0.001, 0.1, 0.001).name(
      "Animation Speed (Base)"
    );
    f1.add(CONFIG, "dotScaleFactor", 0.1, 5.0, 0.05).name(
      "Dot Scale Factor (Base)"
    );
    f1.add(CONFIG, "isPaused").name("Pause Animation");

    const f2 = gui.addFolder("Location");
    f2.add(CONFIG, "city").onFinishChange(() => {
      /* Todo: Geocode */
    });
    f2.add(CONFIG, "lat").onFinishChange(fetchWeather);
    f2.add(CONFIG, "lon").onFinishChange(fetchWeather);

    const f3 = gui.addFolder("Export");
    f3.add(CONFIG, "exportSize", ["current", "a4"]).name("SVG Size");

    // Audio/MIDI controls
    const f4 = gui.addFolder("Audio/MIDI");
    f4.add(CONFIG, "enableAudio")
      .name("Enable Audio")
      .onChange(updateAudioMIDISettings);
    f4.add(CONFIG, "enableMIDI").name("Enable MIDI");
    f4.add(CONFIG, "audioNoiseScaleSensitivity", 0, 2, 0.1).name(
      "Audio → Noise Scale"
    );
    f4.add(CONFIG, "audioDotScaleSensitivity", 0, 3, 0.1).name(
      "Audio → Dot Scale"
    );
    f4.add(CONFIG, "midiAnimationSpeedSensitivity", 0, 0.1, 0.001).name(
      "MIDI → Animation Speed"
    );
    f4.add(CONFIG, "midiMatrixSizeSensitivity").name("MIDI → Matrix Size");

    // 4. Bind Buttons

    // exportSVG
    document
      .getElementById("btn-export-svg")
      .addEventListener("click", function () {
        if (sketch && sketch.exportSvg) {
          sketch.exportSvg(CONFIG.exportSize);
        }
      });

    // exportPNG
    document
      .getElementById("btn-export-png")
      .addEventListener("click", async function () {
        try {
          const canvas = await html2canvas(els.frame, {
            scale: 2,
            useCORS: true,
            backgroundColor: null,
          });

          const link = document.createElement("a");
          link.download = `${title}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
        } catch (err) {
          console.error("PNG Export failed", err);
        }
      });
  }

  // Run
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>

<!-- This component sets up the global function -->
<SketchSetup />
