---
/**
 * Dot Matrix Sketch - Simplified sketch 
 * 
 * 
 * @param {Object} config - Configuration object
 * @returns {Object} Sketch object with setup, draw, and exportSvg methods
 */
---

<script>
  /**
   * Creates a simplified dot matrix sketch that visualizes audio/MIDI input
   * @param {Object} config - Configuration object
   * @param {number} config.width - Canvas width
   * @param {number} config.height - Canvas height
   * @param {number} config.matrixSize - Initial matrix size (4, 8, 16, 32, 64)
   * @param {string} config.theme - Color theme name
   * @param {number} config.noiseScale - Base noise scale (0.01-0.8)
   * @param {number} config.dotScaleFactor - Base dot scale factor (0.5-3.0)
   * @param {number} config.animationSpeed - Base animation speed (0.001-0.1)
   * @param {boolean} config.debug - Enable console logging of audio/MIDI data
   */
  export function createDotMatrixSketch(config) {
    let PixelDisplay;

    const GR__ = 1.618;
    let PIXEL_SCALE;
    let PIXEL_GAP;
    let MATRIX_WIDTH;
    let MATRIX_HEIGHT;
    let display;
    let zOffset = 0;

    // Audio/MIDI controller reference
    const DEBUG = config.debug || false;
    let frameCount = 0;

    // Store base values for audio/MIDI modulation
    const baseValues = {
      noiseScale: config.noiseScale || 0.05,
      dotScaleFactor: config.dotScaleFactor || 1.0,
      animationSpeed: config.animationSpeed || 0.002,
      matrixSize: config.matrixSize || 4,
    };

    // Audio/MIDI sensitivity settings (read from config dynamically)
    function getAudioMIDISensitivity() {
      return {
        noiseScale: config.audioNoiseScaleSensitivity || 0.5,
        dotScaleFactor: config.audioDotScaleSensitivity || 1.0,
        animationSpeed: config.midiAnimationSpeedSensitivity || 0.05,
        matrixSize: config.midiMatrixSizeSensitivity !== false,
      };
    }

    // Simplified color themes
    const colorThemes = {
      "2a": { off: [13, 13, 13], on: [204, 165, 69] },
      milk_transparent: { off: "transparent", on: [13, 13, 13] },
      green: { off: [13, 13, 13], on: [100, 255, 100] },
      amber: { off: [40, 20, 0], on: [255, 180, 0] },
      white: { off: [40, 40, 40], on: [220, 220, 220] },
      blue: { off: [10, 20, 40], on: [80, 160, 255] },
    };

    // Initialize config defaults
    if (!config.matrixSize) config.matrixSize = 4;
    if (!config.theme) config.theme = "green";
    if (!config.dotScaleFactor) config.dotScaleFactor = 1.0;

    function resetSketch() {
      MATRIX_WIDTH = Number(config.matrixSize);
      MATRIX_HEIGHT = Number(config.matrixSize);
      PIXEL_SCALE = config.width / MATRIX_WIDTH;
      PIXEL_GAP = PIXEL_SCALE - PIXEL_SCALE / Math.pow(GR__, 1);

      resizeCanvas(MATRIX_WIDTH * PIXEL_SCALE, MATRIX_HEIGHT * PIXEL_SCALE);

      if (typeof PixelDisplay !== "undefined") {
        display = new PixelDisplay(
          MATRIX_WIDTH,
          MATRIX_HEIGHT,
          PIXEL_SCALE,
          PIXEL_GAP
        );
        updateColorTheme();
      }
    }

    /**
     * Update color theme from config
     */
    function updateColorTheme() {
      if (!display) return;
      const theme = colorThemes[config.theme];
      display.setColors(
        Array.isArray(theme.off) ? color(...theme.off) : theme.off,
        Array.isArray(theme.on) ? color(...theme.on) : theme.on,
        Array.isArray(theme.on) ? color(...theme.on) : theme.on // stroke same as on
      );
    }

    /**
     * Log audio/MIDI data to console for debugging
     * @param {Object} audioData - Audio data from controller
     * @param {Object} midiData - MIDI data from controller
     */
    function logAudioMIDIData(audioData, midiData) {
      if (!DEBUG || frameCount % 60 !== 0) return; // Log once per second at 60fps

      console.group("ðŸŽµ Audio/MIDI Data");
      if (audioData) {
        console.log("Audio:", {
          volume: audioData.volume.toFixed(3),
          bass: audioData.bass.toFixed(3),
          mid: audioData.mid.toFixed(3),
          treble: audioData.treble.toFixed(3),
        });
      }
      if (midiData) {
        console.log("MIDI:", {
          activeNotes: midiData.activeNotes,
          noteCount: midiData.activeNotes.length,
          velocity: midiData.velocity,
          cc: midiData.cc,
        });
      }
      console.log("Applied Parameters:", {
        noiseScale: config.noiseScale.toFixed(4),
        dotScaleFactor: config.dotScaleFactor.toFixed(2),
        animationSpeed: config.animationSpeed.toFixed(4),
        matrixSize: config.matrixSize,
      });
      console.groupEnd();
    }

    const sketch = {
      setup: () => {
        if (typeof window !== "undefined") {
          MATRIX_WIDTH = Number(config.matrixSize);
          MATRIX_HEIGHT = Number(config.matrixSize);
          PIXEL_SCALE = config.width / MATRIX_WIDTH;
          PIXEL_GAP = PIXEL_SCALE - PIXEL_SCALE / Math.pow(GR__, 0);

          createCanvas(
            MATRIX_WIDTH * PIXEL_SCALE,
            MATRIX_HEIGHT * PIXEL_SCALE
          );
        }
      },

      init: (PixelDisplayClass) => {
        PixelDisplay = PixelDisplayClass;

        MATRIX_WIDTH = Number(config.matrixSize);
        MATRIX_HEIGHT = Number(config.matrixSize);
        PIXEL_SCALE = config.width / MATRIX_WIDTH;
        PIXEL_GAP = PIXEL_SCALE - PIXEL_SCALE / Math.pow(GR__, 0);

        display = new PixelDisplay(
          MATRIX_WIDTH,
          MATRIX_HEIGHT,
          PIXEL_SCALE,
          PIXEL_GAP
        );
        updateColorTheme();

      },

      draw: () => {
        if (config.isPaused || !display) return;

        frameCount++;

        // Render the dot matrix
        clear();
        push();
        display.clear();

        // Generate Perlin noise pattern
        for (let y = 0; y < display.matrixHeight; y++) {
          for (let x = 0; x < display.matrixWidth; x++) {
            const noiseVal = noise(
              x * config.noiseScale,
              y * config.noiseScale,
              zOffset
            );
            display.setPixel(x, y, noiseVal);
          }
        }

        zOffset += config.animationSpeed || 0.002;

        // Render display (simplified - no hatch fill)
        display.render(0, 0, {
          dotScaleFactor: config.dotScaleFactor,
          dotNoiseInfluence: 1.0,
          useColorThemeShading: false,
        });
        pop();
      },

      resize: (newWidth, newHeight) => {
        config.width = newWidth;
        config.height = newHeight;
        resetSketch();
      },

      exportSvg: (exportSize = "current") => {
        if (!display) return;

        const svgRenderer = (p) => {
          p.setup = () => {
            let w, h;
            if (exportSize === "a4") {
              w = 794;
              h = 1123;
            } else {
              w = MATRIX_WIDTH * PIXEL_SCALE;
              h = MATRIX_HEIGHT * PIXEL_SCALE;
            }

            p.createCanvas(w, h, p.SVG);
            p.noLoop();
            p.background(200, 0);
            p.noStroke();

            // Simple dot rendering for SVG export
            for (let x = 0; x < display.matrixWidth; x++) {
              for (let y = 0; y < display.matrixHeight; y++) {
                const noiseVal = display.pixelMatrix[x][y];
                if (noiseVal === 0) continue;

                p.fill(display.colorOn);

                const baseDotSize = display.pixelScale - display.pixelGap;
                const maxDotSize = baseDotSize * config.dotScaleFactor;
                const scaledDotSize = p.map(noiseVal, 0, 1, 0, maxDotSize);
                const offset = (display.pixelScale - scaledDotSize) / 2;

                p.ellipseMode(p.CORNER);
                p.ellipse(
                  x * display.pixelScale + offset,
                  y * display.pixelScale + offset,
                  scaledDotSize,
                  scaledDotSize
                );
              }
            }
            p.save("dot-matrix-perlin-noise.svg");
          };
        };
        // @ts-ignore - p5 is available globally
        new p5(svgRenderer);
      },

      getDisplay: () => display,

      updateColorTheme: () => updateColorTheme(),


    };

    return sketch;
  }

  // Set up globally so it can be used in the main file
  if (typeof window !== "undefined") {
    window.createDotMatrixSketch = createDotMatrixSketch;
  }
</script>
